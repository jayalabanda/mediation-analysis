---
title: "Estimations of causal quantities - without time-varying confounders affected by the exposure"
author: "Benoit Lepage + complete"
date: "09/07/2020"
output: 
  html_document:
    code_folding: hide
    number_sections: yes
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE)  # to use "myround" command
```

```{r load_packages, include=FALSE}
library(broman)
```

# Data generating mechanism

Here, we define the data generating mechanisms, characterized by a causal model and a statistical model that generate data given in example. 

Two data generating mechanisms are defined: "mediator-outcome confounder affected by the exposure" is absent in the first one and is present in the second.

## Data generating mechanism without mediator-outcome confounder affected by the exposure

This data generating mechanism is defined by the following set of structural equations:
$$\begin{array}{lll}
P(L(0)_{male} = 1) &=& p_{L(0)_{male}}\\
P(L(0)_{parent} = 1) &=& p_{L(0)_{parent}}\\
P(A_{ACE} = 1) &=& \beta_{A} + \beta_{male}^A \times L(0)_{male} + \beta_{parent}^A \times L(0)_{parent}\\
P(L(1) = 1) &=& p_{L(1)}\\
P(M_{smoking} = 1) &=& \beta_{M} + \beta_{male}^M \times L(0)_{male} + \beta_{parent}^M \times L(0)_{parent} + \beta_{L(1)}^M \times L(1) + \beta_{A}^M \times A_{ACE}\\
P(Y_{death} = 1) &=& \beta_{Y} + \beta_{male}^Y \times L(0)_{male} + \beta_{parent}^Y \times L(0)_{parent} + \beta_{L(1)}^Y \times L(1)\\
                 & & + \beta_{A}^Y \times A_{ACE} + \beta_{M}^Y \times M_{smoking} + \beta_{A \ast M }^Y \times A_{ACE} \times M_{smoking}\\
\mathbb{E}(Y_{Qol} = 1) &=& \gamma_{Y} + \gamma_{male}^Y \times L(0)_{male} + \gamma_{parent}^Y \times L(0)_{parent} + \gamma_{L(1)}^Y \times L(1)\\
                        & &+ \gamma_{A}^Y \times A_{ACE} + \gamma_{M}^Y \times M_{smoking} + \gamma_{A \ast M }^Y \times A_{ACE} \times M_{smoking} + \varepsilon_Y
\end{array}$$
where $\varepsilon_Y \sim \mathcal{N}(0,\sigma_Y = 10)$.

One can set the parameters of these structural equations using the following function `sim.param.no.time.varying.L`:
```{r sim_param_no_time_varying_conf, echo=TRUE}
sim.param.no.time.varying.L <- function(A.M.interaction = NULL) {
# L0
p_L0_male <- 0.5
p_L0_parent_low_educ_lv <- 0.65

# A: A0_ace <- rbinom( 0.05 + 0.04 * L0_male + 0.06 * L0_parent_low_educ_lv ) 
b_A <- 0.05   # reference prevalence is 5%
b_male_A <- 0.04  # + 0.04 for the effect of L0_male -> A0_ace
b_parent_educ_A <- 0.06  # +0.06 for the effect of L0_parent_low_educ_lv -> A0_ace

# L1: intermediate confounder between M and Y, not influenced by A
p_L1 <- 0.3

# M: M_smoking <- rbinom( 0.2 + 0.05 * L0_male + 0.06 * L0_parent_low_educ_lv + 0.07 * L1 + 0.1 * A0_ace ) 
b_M <- 0.2 # reference prevalence is 20%
b_male_M <- 0.05 # +0.05 for the effect of L0_male -> M_smoking
b_parent_educ_M <- 0.06 # +0.06 for the effect of L0_parent_low_educ_lv -> M_smoking
b_L1_M <- 0.07 # +0.07 for the effect of L1 -> M_smoking
b_A_M <- 0.1 # +0.10 for the effect of A0_ace -> M_smoking

# Y binary: rbinom( 0.10 + 0.06 * L0_male + 0.04 * L0_parent_low_educ_lv + 0.05 * A0_ace + 0.07 * L1 + 0.08 * M_smoking +
#                   0.03 * A0_ace * M_smoking * A.M.inter ) 
b_Y <- 0.1 # reference prevalence is 10%
b_male_Y <- 0.06 # +0.06 for the effect of L0_male -> Y
b_parent_educ_Y <- 0.04 # +0.04 for the effect of L0_parent_low_educ_lv -> Y
b_A_Y <- 0.05 # 0.05 for the effect of A0_ace -> Y
b_L1_Y <- 0.07 # +0.07 for the effect of L1 -> Y
b_M_Y <- 0.08 # 0.08 for the effect of M_smoking -> Y
b_AM_Y <- 0.03 # 0.03 for the interaction effect A0_ace * M_smoking -> Y

# Y continuous: (75 - 1 * L0_male - 3 * L0_parent_low_educ_lv - 4 * A0_ace -3.5 * L1 - 9 * M_smoking + 
#             -5 * A0_ace * M_smoking * A.M.inter ) + rnorm(N, mean = 0, sd = 10)
mu_Y <- 75 # reference mean for QoL
c_male_Y <- -1 # -1 for the effect of L0_male -> Y
c_parent_educ_Y <- -3 # -3 for the effect of L0_parent_low_educ_lv -> Y
c_A_Y <- -4 # -4 for the effect of A0_ace -> Y
c_L1_Y <- -3.5 # -3.5 for the effect of L1 -> Y
c_M_Y <- -9 # -9 for the effect of M_smoking -> Y
c_AM_Y <- -5  # - 5 for the interaction effect A0_ace * M_smoking  -> Y
sd_Y <- 10 # standard deviation of the residuals

# A*M interaction ?
A.M.inter <- A.M.interaction

coef <- c( p_L0_male = p_L0_male, p_L0_parent_low_educ_lv = p_L0_parent_low_educ_lv, 
              b_A = b_A, b_male_A = b_male_A, b_parent_educ_A = b_parent_educ_A, 
              p_L1 = p_L1,
              b_M = b_M, b_male_M = b_male_M, b_parent_educ_M = b_parent_educ_M, b_L1_M = b_L1_M, b_A_M = b_A_M,
              b_Y = b_Y, b_male_Y = b_male_Y, b_parent_educ_Y = b_parent_educ_Y, b_A_Y = b_A_Y, b_L1_Y = b_L1_Y, b_M_Y = b_M_Y, b_AM_Y = b_AM_Y,
              mu_Y = mu_Y, c_male_Y = c_male_Y, c_parent_educ_Y = c_parent_educ_Y, c_A_Y = c_A_Y, c_L1_Y = c_L1_Y, c_M_Y = c_M_Y, c_AM_Y = c_AM_Y, 
              sd_Y = sd_Y, A.M.inter = A.M.inter)
  
  return(coef)
}
```

## Data generating function in R
The following function `gen.data.no.time.varying.L` can be used to simulate data sets using the parameters defined previously in the `sim.param.no.time.varying.L` function.

```{r sim_data_no_time_varying_conf, echo=TRUE}
gen.data.no.time.varying.L <- function(N, A.M.inter) { # input parameters are the sample size N and the presence of A*M interaction with A.M.inter = 0 or 1
  
  b <- sim.param.no.time.varying.L(A.M.interaction = A.M.inter)
    
  # baseline confounders: parent's educational level=L0_parent_low_educ_lv & sex=L0_male
  L0_male <- rbinom(N, size = 1, prob = b["p_L0_male"]) 
  L0_parent_low_educ_lv <- rbinom(N, size = 1, prob = b["p_L0_parent_low_educ_lv"])  
  
  # exposure: A0_ace
  A0_ace <- rbinom(N, size = 1, prob =  b["b_A"] + 
                     b["b_male_A"] * L0_male + 
                     b["b_parent_educ_A"] * L0_parent_low_educ_lv ) 
  
  # intermediate confounder between M_smoking and Y, not affected by A0 L1
  L1 <- rbinom(N, size = 1, prob = b["p_L1"])
  
  # mediator: M_smoking
  M_smoking <- rbinom(N, size = 1, prob = b["b_M"] + 
                        b["b_male_M"] * L0_male + 
                        b["b_parent_educ_M"] * L0_parent_low_educ_lv + 
                        b["b_A_M"] * A0_ace +
                        b["b_L1_M"] * L1) 

  # Y_death 
  Y_death <- rbinom(N, size = 1, prob = b["b_Y"] + 
                      b["b_male_Y"] * L0_male + 
                      b["b_parent_educ_Y"] * L0_parent_low_educ_lv + 
                      b["b_A_Y"] * A0_ace + 
                      b["b_L1_Y"] * L1 +
                      b["b_M_Y"] * M_smoking +
                      b["b_AM_Y"] * A0_ace * M_smoking * A.M.inter ) 
  
  # Y_qol 
  Y_qol <- ( b["mu_Y"] + 
               b["c_male_Y"] * L0_male + 
               b["c_parent_educ_Y"] * L0_parent_low_educ_lv +
               b["c_A_Y"] * A0_ace +
               b["c_L1_Y"] * L1 +
               b["c_M_Y"] * M_smoking + 
               b["c_AM_Y"] * A0_ace * M_smoking * A.M.inter ) + 
    rnorm(N, mean = 0, sd = b["sd_Y"])
  
  # data.frame
  data.sim <- data.frame(L0_male, L0_parent_low_educ_lv, A0_ace, L1, M_smoking, Y_death, Y_qol)

  return( data.sim )
}
```

A simulated data set of size N=10000 is then generated (including an A*M interaction term in this example). 

```{r simulate_data, echo=TRUE}
set.seed(1234)
data.sim <- gen.data.no.time.varying.L(N=10000, A.M.inter=1)
```

```{r show_data, echo=TRUE}
head(data.sim)
```

# Estimation of the average total effect (ATE)
The average total effect (ATE), expressed using counterfactual notation is $\Psi_{ATE} = \mathbb{E}(Y_{A=1}) - \mathbb{E}(Y_{A=0})$. If the ATE is identifiable, it can be expressed using the g-formula:
$$\begin{equation}
\Psi_{ATE} = \sum_{l(0)} \left[ \mathbb{E}(Y \mid A=1, L(0)=l(0)) - \mathbb{E}(Y \mid A=0, L(0)=l(0)) \right] \mathbb{P}(L(0)=l(0)).
\end{equation}$$
  
We will denote $\bar{Q}(a) = \mathbb{E}(Y \mid A=a, L(0))$.

## G-computation
The following steps describe the implementation of the g-computation estimator
                                          
1. Fit a logistic or a linear regression to estimate $\bar{Q} = \mathbb{E}(Y \mid A, L(0))$
                                            
2. Use this estimate to predict an outcome for each subject $\hat{\bar{Q}}(A=0)_i$ and $\hat{\bar{Q}}(A=1)_i$, by evaluating the regression fit $\bar{Q}$ at $A=0$ and $A=1$ respectively
                                          
3. Plug the predicted outcomes in the g-formula and use the sample mean to estimate $\Psi_{ATE}$
$$\begin{equation}
\hat{\Psi}_{ATE} = \frac{1}{n} \sum_{i=1}^n \left[ \hat{\bar{Q}}(A=1)_i - \hat{\bar{Q}}(A=0)_i \right]
\end{equation}$$

```{r Psi.ATE.gcomp, echo=TRUE}
# 1. Estimate Qbar
Q.tot.death <- glm(Y_death ~ L0_male + L0_parent_low_educ_lv + A0_ace, family = "binomial", data = data.sim)
Q.tot.qol <- glm(Y_qol ~ L0_male + L0_parent_low_educ_lv + A0_ace, family = "gaussian", data = data.sim)

# 2. Predict an outcome for each subject, setting A=0 and A=1
# prepare data sets used to predict the outcome under the counterfactual scenarios setting A=0 and A=1
data.A1 <- data.A0 <- data.sim
data.A1$A0_ace <- 1
data.A0$A0_ace <- 0

# predict values
Y1.death.pred <- predict(Q.tot.death, newdata = data.A1, type = "response")
Y0.death.pred <- predict(Q.tot.death, newdata = data.A0, type = "response")

Y1.qol.pred <- predict(Q.tot.qol, newdata = data.A1, type = "response")
Y0.qol.pred <- predict(Q.tot.qol, newdata = data.A0, type = "response")

# 3. Plug the predicted outcome in the gformula and use the sample mean to estimate the ATE
ATE.death.gcomp <- mean(Y1.death.pred - Y0.death.pred)
ATE.qol.gcomp <- mean(Y1.qol.pred - Y0.qol.pred)
```

In these examples, the ATE estimates for death probability and mean quality of life are respectively : 
```{r show_results_ATE, echo=TRUE}
ATE.death.gcomp
ATE.qol.gcomp
```

A 95% confidence interval can be estimated applying a bootstrap procedure. An example is given in the following code.
```{r ATE_gcomputation_95CI}
B <- 10 # note: the number of bootstrap samples should be larger, for example B=2000 or B=3000
bootstrap.estimates <- data.frame(matrix(NA, nrow = B, ncol = 2))
colnames(bootstrap.estimates) <- c("boot.death.estimate", "boot.qol.estimate")
for (b in 1:B){
  # sample the indices 1 to n with replacement
  bootIndices <- sample(1:nrow(data.sim), replace=T) 
  bootData <- data.sim[bootIndices,]
  
  #if ( round(b/100, 0) == b/100 ) print(paste0("bootstrap number ",b))
  
  Q.tot.death <- glm(Y_death ~ L0_male + L0_parent_low_educ_lv + A0_ace, family = "binomial", data = bootData)
  Q.tot.qol <- glm(Y_qol ~ L0_male + L0_parent_low_educ_lv + A0_ace, family = "gaussian", data = bootData)
  
  boot.A.1 <- boot.A.0 <- bootData
  boot.A.1$A0_ace <- 1
  boot.A.0$A0_ace <- 0
  
  Y1.death.boot <- predict(Q.tot.death, newdata = boot.A.1, type = "response")
  Y0.death.boot <- predict(Q.tot.death, newdata = boot.A.0, type = "response")
  
  Y1.qol.boot <- predict(Q.tot.qol, newdata = boot.A.1, type = "response")
  Y0.qol.boot <- predict(Q.tot.qol, newdata = boot.A.0, type = "response")
  
  bootstrap.estimates[b,"boot.death.estimate"] <- mean(Y1.death.boot - Y0.death.boot) 
  bootstrap.estimates[b,"boot.qol.estimate"] <- mean(Y1.qol.boot - Y0.qol.boot) 
}
  
IC95.ATE.death <- c(ATE.death.gcomp - qnorm(0.975)*sd(bootstrap.estimates[,"boot.death.estimate"]), 
                      ATE.death.gcomp + qnorm(0.975)*sd(bootstrap.estimates[,"boot.death.estimate"]) )
IC95.ATE.death
  
IC95.ATE.qol <- c(ATE.qol.gcomp - qnorm(0.975)*sd(bootstrap.estimates[,"boot.qol.estimate"]), 
                    ATE.qol.gcomp + qnorm(0.975)*sd(bootstrap.estimates[,"boot.qol.estimate"]) )
IC95.ATE.qol
```



## IPTW
### IPTW estimator for the ATE

If the average total effect (ATE) is identifiable, $\Psi_{ATE} = \mathbb{E}(Y_{A=1}) - \mathbb{E}(Y_{A=0})$ can be expressed using Inverse probability of treatment weighting (IPTW), denoting $\mathbb{P}(A=a \mid L(0)) = g(A=a \mid L(0))$:
$$\begin{equation}
\Psi_{ATE} = \mathbb{E}\left( \frac{\mathbb{I}(A=1)}{g(A=1 \mid L(0))} Y \right) - \mathbb{E}\left( \frac{\mathbb{I}(A=0)}{g(A=0 \mid L(0))} Y \right)
\end{equation}$$
  
The following steps describe the implementation of the IPTW estimator


1. Estimate the treatment mechanism $g(A=1 \mid L(0))$

2. Predict each individual's probability of being exposed to her own exposure

3. Apply weights corresponding to the inverse of the predicted probability $w_i = \frac{1}{\hat{g}(A_i = a \mid L(0)_i)}$

4. Use the empirical mean of the weighted outcome $Y$: $\hat{\mathbb{E}}(Y_a) = \frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=a)}{\hat{g}(A_i=a \mid L(0)_i)} Y_i$

```{r Psi.ATE.iptw, echo=TRUE}
# 1. Estimate g
g.L <- glm(A0_ace ~ L0_male + L0_parent_low_educ_lv, family = "binomial", data = data.sim)

# 2. Predict each individual's probability of being exposed to her own exposure
# predict the probabilities P(A0_ace=1|L(0)) & P(A0_ace=0|L(0))
pred.g1.L <- predict(g.L, type="response")
pred.g0.L <- 1 - pred.g1.L
# the predicted probability of the observed treatment A_i=a is : 
gA.L <- rep(NA, nrow(data.sim))
gA.L[data.sim$A0_ace==1] <- pred.g1.L[data.sim$A0_ace==1]
gA.L[data.sim$A0_ace==0] <- pred.g0.L[data.sim$A0_ace==0]

# 3. Apply weights corresponding to the inverse of the predicted probability
wt <- 1 / gA.L

# 4. Use the empirical mean of the weighted outcome
# point estimates:
IPTW.death <- mean(wt * as.numeric(data.sim$A0_ace==1) * data.sim$Y_death) -
               mean(wt * as.numeric(data.sim$A0_ace==0) * data.sim$Y_death)
IPTW.qol <- mean(wt * as.numeric(data.sim$A0_ace==1) * data.sim$Y_qol) -
             mean(wt * as.numeric(data.sim$A0_ace==0) * data.sim$Y_qol)
```

The ATE estimates using IPTW for death probability and mean quality of life are respectively : 
```{r show_results_iptw, echo=TRUE}
IPTW.death
IPTW.qol
```

### Stabilized IPTW for the ATE
If the average total effect (ATE) is identifiable, $\Psi_{ATE}$ can be estimated using a stabilized IPTW estimator:
$$\begin{equation}
\hat{\mathbb{E}}(Y_1) - \hat{\mathbb{E}}(Y_0) =  \frac{\frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=1)\hat{g}^*(A_i=1)}{\hat{g}(A_i=1 \mid L(0)_i)} Y_i}{ \frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=1)\hat{g}^*(A_i=1)}{\hat{g}(A_i=1 \mid L(0)_i)}} - \frac{\frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=0)\hat{g}^*(A_i=0)}{\hat{g}(A_i=0 \mid L(0)_i)} Y_i}{ \frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=0)\hat{g}^*(A_i=0)}{\hat{g}(A_i=0 \mid L(0)_i)}}
\end{equation}$$
The estimation algorithm is the same as for IPTW, but taking into account any non-null function of $A$ ($g^*(A_i=a)$) in the denominator of the weight in step 3, and applying the stabilized estimator in step 4.

```{r Psi.ATE.siptw, echo=TRUE}
# 3. For example, applying g^*(A) = 1
# 4. Applying the stabilized estimator
# point estimates:
s.IPTW.death <- (mean(wt * as.numeric(data.sim$A0_ace==1) * data.sim$Y_death) / 
                   mean(wt * as.numeric(data.sim$A0_ace==1))) -
                 (mean(wt * as.numeric(data.sim$A0_ace==0) * data.sim$Y_death) / 
                    mean(wt * as.numeric(data.sim$A0_ace==0)))

s.IPTW.qol <- (mean(wt * as.numeric(data.sim$A0_ace==1) * data.sim$Y_qol) / 
                 mean(wt * as.numeric(data.sim$A0_ace==1))) -
               (mean(wt * as.numeric(data.sim$A0_ace==0) * data.sim$Y_qol) /
                  mean(wt * as.numeric(data.sim$A0_ace==0)))
```

The ATE estimates using stabilized IPTW for death probability and mean quality of life are respectively : 
```{r show_results_siptw, echo=TRUE}
s.IPTW.death
s.IPTW.qol
```

## Targeted maximum likelihood estimation (TMLE)
Rose & van der Laan describe the Targeted maximum likelihood estimation (TMLE) as a 2-step procedure:

1) Estimate the relevant portion $\bar{Q}$ of the data-generating distribution,

2) Update this initial fit (using an estimate of the treatment mechanism $g$), targeting toward making an optimal bias-variance tradeoff for the parameter of interest $\Psi_{ATE}$.

TMLE is a double robust estimation, i.e. it removes the asymptotic bias of the initial estimator of $\Psi_{ATE}$ if it uses a consistent estimator of the treatment mechanism $g$. Moreover, if both the initial estimator $\bar{Q}$ and the treatment mechanism $g$ are consistent, TMLE is asymptotically efficient. It can incorporate data-adaptive estimation procedures (ensemble learning) to estimate $\bar{Q}$ and $g$. 

We can use the `tmle` package to estimate the total effect by TMLE. 

The `tmle` function is called with the following arguments, as shown in the example below:

- $Y$, a binary or continuous outcome,

- $A$, a binary treatment or exposure of interest,

- $W$, the set of baseline confounders,

- a set of prediction algorithms to use for SuperLearner estimation of initial $\bar{Q}$ and treatment mechanism $g$

```{r Psi.ATE.tmle, echo=TRUE, message=FALSE, warning=FALSE}
library(tmle)
ATE.tmle.death <- tmle(Y = data.sim$Y_death,
                 A = data.sim$A0_ace,
                 W = subset(data.sim, select = c(L0_male, L0_parent_low_educ_lv)) ,
                 Qform = NULL,
                 Q.SL.library = c("SL.glm"), # the library should include a varied set of algorithms
                                             # Q.SL.library = c("SL.glm", "SL.glmnet", "SL.bartMachine")
                 cvQinit = TRUE, # should be TRUE to estimate cross-validated predicted values
                 gform = NULL,
                 g.SL.library = c("SL.glm"), # the library should include a varied set of algorithms
                                             # g.SL.library = c("SL.glm", "SL.gam", "SL.bartMachine")
                 family = "binomial",
                 V = 10)

ATE.tmle.qol <- tmle(Y = data.sim$Y_qol,
                       A = data.sim$A0_ace,
                       W = subset(data.sim, select = c(L0_male, L0_parent_low_educ_lv)) ,
                       Qform = NULL,
                       Q.SL.library = c("SL.glm"), # the library should include a various set of algorithms
                       cvQinit = TRUE, # should be TRUE to estimate cross-validated predicted values
                       gform = NULL,
                       g.SL.library = c("SL.glm"), # the library should include a various set of algorithms
                       family = "gaussian",
                       V = 10)
```

The ATE estimates using TMLE for death probability and mean quality of life are respectively :
```{r show_results_tmle, echo=TRUE}
list("psi" = ATE.tmle.death$estimates$ATE$psi,
     "CI" = ATE.tmle.death$estimates$ATE$CI)
list("psi" = ATE.tmle.qol$estimates$ATE$psi,
     "CI" = ATE.tmle.qol$estimates$ATE$CI)
```


# Controlled direct effect
For a binary exposure $A=\{0,1\}$ and setting the exposure to the mediator to a counterfactual value $do(M=m)$, the controlled direct effect (CDE) expressed using counterfactual notation is $\Psi_{CDE} = \mathbb{E}(Y_{1m}) - \mathbb{E}(Y_{0m}). If the CDE is identifiable, it can be expressed using the g-formula:
$$\begin{align*}
\Psi_{CDE_m} &= \mathbb{E}(Y_{1m}) - \mathbb{E}(Y_{0m})  \\
           &= \sum_{l(0),l(1)} [ \mathbb{E}(Y \mid M=m, L(1)=l(1), A=1, L(0)=l(0)) \mathbb{P}(L(1)=l(1) \mid A=1, L(0)=l(0))  \\
           & \quad \quad \quad \quad - \mathbb{E}(Y \mid M=m, L(1)=l(1), A=0, L(0)=l(0)) \mathbb{P}(L(1)=l(1) \mid A=0, L(0)=l(0)) ] \times \mathbb{P}(L(0)=l(0)) 
\end{align*}$$

Assuming that $L(1)$ is not affected by the exposure $A$, then the g-formula is simplified
$$\begin{align*}
\Psi_{CDE_m} &= \mathbb{E}(Y_{1m}) - \mathbb{E}(Y_{0m})  \\
           &= \sum_{l(0),l(1)} [ \mathbb{E}(Y \mid M=m, L(1)=l(1), A=1, L(0)=l(0)) - \mathbb{E}(Y \mid M=m, L(1)=l(1), A=0, L(0)=l(0)) ] \\
           & \quad \quad \quad \quad \times \mathbb{P}(L(1)=l(1),L(0)=l(0)) 
\end{align*}$$

We will denote $\bar{Q}(a,m) = \mathbb{E}(Y \mid M=m, L(1), A=a, L(0))$.

## G-computation
The following steps describe the implementation of the g-computation estimator

1. Fit a logistic or a linear regression to estimate $\bar{Q}(a,m) = \mathbb{E}(Y \mid M, L(1), A, L(0))$
                                            
2. Use this estimate to predict an outcome for each subject $\hat{\bar{Q}}(A=0,M=m)_i$ and $\hat{\bar{Q}}(A=1, M=m)_i$, by evaluating the regression fit $\bar{Q}(a,m)$ at $(A=0,M=m)$ and $(A=1,M=m)$ respectively
                                          
3. Plug the predicted outcomes in the g-formula and use the sample mean to estimate $\Psi_{CDE}$
$$\begin{equation}
\hat{\Psi}_{CDE_m} = \frac{1}{n} \sum_{i=1}^n \left[ \hat{\bar{Q}}(A=1,M=m)_i - \hat{\bar{Q}}(A=0,M=m)_i \right]
\end{equation}$$
 
```{r Psi.CDE.gcomp, echo=TRUE}
# 1. Estimate Qbar
Qam.tot.death <- glm(Y_death ~ L0_male + L0_parent_low_educ_lv + L1 + A0_ace + M_smoking + A0_ace:M_smoking, 
                     family = "binomial", data = data.sim)
Qam.tot.qol <- glm(Y_qol ~ L0_male + L0_parent_low_educ_lv + L1 + A0_ace + M_smoking + A0_ace:M_smoking, 
                   family = "gaussian", data = data.sim)

# 2. Predict an outcome for each subject, setting (A=0, M=m) and (A=1, M=m)
# prepare data sets used to predict the outcome under the counterfactual scenarios 
# setting (A=0,M=0) and (A=1,M=0), as well as (A=0,M=1) and (A=1,M=1)
data.A1M1 <- data.A1M0 <- data.A0M1 <- data.A0M0 <- data.sim
data.A0M0$A0_ace <- 0
data.A0M0$M_smoking <- 0

data.A0M1$A0_ace <- 0
data.A0M1$M_smoking <- 1

data.A1M0$A0_ace <- 1
data.A1M0$M_smoking <- 0

data.A1M1$A0_ace <- 1
data.A1M1$M_smoking <- 1

# predict values
Q.A0M0.death.pred <- predict(Qam.tot.death, newdata = data.A0M0, type = "response")
Q.A1M0.death.pred <- predict(Qam.tot.death, newdata = data.A1M0, type = "response")
Q.A0M1.death.pred <- predict(Qam.tot.death, newdata = data.A0M1, type = "response")
Q.A1M1.death.pred <- predict(Qam.tot.death, newdata = data.A1M1, type = "response")

Q.A0M0.qol.pred <- predict(Qam.tot.qol, newdata = data.A0M0, type = "response")
Q.A1M0.qol.pred <- predict(Qam.tot.qol, newdata = data.A1M0, type = "response")
Q.A0M1.qol.pred <- predict(Qam.tot.qol, newdata = data.A0M1, type = "response")
Q.A1M1.qol.pred <- predict(Qam.tot.qol, newdata = data.A1M1, type = "response")

# 3. Plug the predicted outcome in the gformula and use the sample mean to estimate the CDE
CDE.death.m0.gcomp <- mean(Q.A1M0.death.pred) - mean(Q.A0M0.death.pred)
CDE.death.m1.gcomp <- mean(Q.A1M1.death.pred) - mean(Q.A0M1.death.pred)

CDE.qol.m0.gcomp <- mean(Q.A1M0.qol.pred) - mean(Q.A0M0.qol.pred)
CDE.qol.m1.gcomp <- mean(Q.A1M1.qol.pred) - mean(Q.A0M1.qol.pred)
```

In these examples, the CDE estimates using g-computation for death probability and mean quality of life, setting $M=0$ are respectively : 
```{r show_results_CDEm0_gcomp, echo=TRUE}
CDE.death.m0.gcomp

CDE.qol.m0.gcomp
```

The CDE estimates using g-computation for death probability and mean quality of life, setting $M=1$ are respectively : 
```{r show_results_CDEm1_gcomp, echo=TRUE}
CDE.death.m1.gcomp

CDE.qol.m1.gcomp
```

The `ltmle` package can be used to get g-computation estimation of CDE. The `ltmle` function is called with the following arguments, as shown in the example below:

- `Anodes`, a set binary treatment or exposure of interest, corresponding in our case to the exposure and the mediator of interest

- `Ynodes`, a binary or continous outcome,

- `Lnodes`, the set of time-varying confounders,

- `abar`, list of two counterfactual interventions on $A$ and $M$ to compare,

- formulas for the outcome and for the treatment mechanisms. $A \star M$ interaction terms can be included in the Q formula of the outcome. 

- A set of prediction algorithms to use for SuperLearner estimation of initial $\bar{Q}$ and treatment mechanism $g$

```{r Psi.CDE.ltmle.gcomp, echo=TRUE, message=FALSE, warning=FALSE}
library(ltmle)
library(SuperLearner)
# 1) death outcome
# setting do(M=0)
ltmle_cde.m0_gcomp_death <- ltmle(data = subset(data.sim, select = -Y_qol ),
                                  Anodes = c("A0_ace","M_smoking"),
                                  Cnodes = NULL,
                                  Lnodes = "L1",
                                  Ynodes = "Y_death",
                                  survivalOutcome = FALSE,
                                  abar=list(c(1,0),c(0,0)),  # setting {A0 = 1, M=0} versus {A0 = 0, M = 0}
                                  Qform = c(L1="Q.kplus1 ~ L0_male + L0_parent_low_educ_lv", 
                                                            # L1 is not affected by A0_ace
                                            Y_death="Q.kplus1 ~ L0_male + L0_parent_low_educ_lv + 
                                                                  A0_ace*M_smoking + L1"),
                                  gform = c("A0_ace ~ L0_male + L0_parent_low_educ_lv",
                                            "M_smoking ~ L0_male + L0_parent_low_educ_lv + A0_ace + L1"),
                                  SL.library=list(Q=list("SL.glm"),  # to get g-comp estimation: 
                                        # choose 1 library and estimate confidence intervals by bootstrap
                                                  g=list("SL.glm")), # to get g-comp estimation: 
                                        # choose 1 library and estimate confidence intervals by bootstrap
                                  gbounds = c(0.01,1),
                                  gcomp = TRUE,           # estimation by g-computation 
                                  variance.method = "ic")
summary.CDE.death.m0.ltmle.gcomp <- summary(ltmle_cde.m0_gcomp_death)

# setting do(M=1)
ltmle_cde.m1_gcomp_death <- ltmle(data = subset(data.sim, select = -Y_qol ),
                                  Anodes = c("A0_ace","M_smoking"),
                                  Cnodes = NULL,
                                  Lnodes = "L1",
                                  Ynodes = "Y_death",
                                  survivalOutcome = FALSE,
                                  abar=list(c(1,1),c(0,1)), # setting {A0 = 1, M=1} versus {A0 = 0, M = 1}
                                  Qform = c(L1="Q.kplus1 ~ L0_male + L0_parent_low_educ_lv", 
                                                            # L1 is not affected by A0_ace
                                            Y_death="Q.kplus1 ~ L0_male + L0_parent_low_educ_lv + 
                                                                  A0_ace*M_smoking + L1"),
                                  gform = c("A0_ace ~ L0_male + L0_parent_low_educ_lv",
                                            "M_smoking ~ L0_male + L0_parent_low_educ_lv + A0_ace + L1"),
                                  SL.library=list(Q=list("SL.glm"),   # to get g-comp estimation: 
                                        # choose 1 library and estimate confidence intervals by bootstrap
                                                  g=list("SL.glm")),   # to get g-comp estimation: 
                                        # choose 1 library and estimate confidence intervals by bootstrap
                                  gbounds = c(0.01,1),
                                  gcomp = TRUE,           # estimation by g-computation 
                                  variance.method = "ic")
summary.CDE.death.m1.ltmle.gcomp <- summary(ltmle_cde.m1_gcomp_death)

# 2) QoL outcome
# setting do(M=0)
ltmle_cde.m0_gcomp_qol <- ltmle(data = subset(data.sim, select = -Y_death ),
                                  Anodes = c("A0_ace","M_smoking"),
                                  Cnodes = NULL,
                                  Lnodes = "L1",
                                  Ynodes = "Y_qol",
                                  survivalOutcome = FALSE,
                                  abar=list(c(1,0),c(0,0)),  # setting {A0 = 1, M=0} versus {A0 = 0, M = 0}
                                  Qform = c(L1="Q.kplus1 ~ L0_male + L0_parent_low_educ_lv", 
                                                # L1 is not affected by A0_ace
                                            Y_qol="Q.kplus1 ~ L0_male + L0_parent_low_educ_lv + 
                                                                A0_ace*M_smoking + L1"),
                                  gform = c("A0_ace ~ L0_male + L0_parent_low_educ_lv",
                                            "M_smoking ~ L0_male + L0_parent_low_educ_lv + A0_ace + L1"),
                                  SL.library=list(Q=list("SL.glm"),   # to get g-comp estimation: 
                                        # choose 1 library and estimate confidence intervals by bootstrap
                                                  g=list("SL.glm")),   # to get g-comp estimation: 
                                        # choose 1 library and estimate confidence intervals by bootstrap
                                  gbounds = c(0.01,1),
                                  gcomp = TRUE,           # estimation by g-computation 
                                  variance.method = "ic")
summary.CDE.qol.m0.ltmle.gcomp <- summary(ltmle_cde.m0_gcomp_qol)

# setting do(M=1)
ltmle_cde.m1_gcomp_qol <- ltmle(data = subset(data.sim, select = -Y_death ),
                                  Anodes = c("A0_ace","M_smoking"),
                                  Cnodes = NULL,
                                  Lnodes = "L1",
                                  Ynodes = "Y_qol",
                                  survivalOutcome = FALSE,
                                  abar=list(c(1,1),c(0,1)), # setting {A0 = 1, M=1} versus {A0 = 0, M = 1}
                                  Qform = c(L1="Q.kplus1 ~ L0_male + L0_parent_low_educ_lv", 
                                                # L1 is not affected by A0_ace
                                            Y_qol="Q.kplus1 ~ L0_male + L0_parent_low_educ_lv + 
                                                                A0_ace*M_smoking + L1"),
                                  gform = c("A0_ace ~ L0_male + L0_parent_low_educ_lv",
                                            "M_smoking ~ L0_male + L0_parent_low_educ_lv + A0_ace + L1"),
                                  SL.library=list(Q=list("SL.glm"), # to get g-comp estimation: 
                                        # choose 1 library and estimate confidence intervals by bootstrap
                                                  g=list("SL.glm")),   # to get g-comp estimation: 
                                        # choose 1 library and estimate confidence intervals by bootstrap
                                  gbounds = c(0.01,1),
                                  gcomp = TRUE,           # estimation by g-computation 
                                  variance.method = "ic")
summary.CDE.qol.m1.ltmle.gcomp <- summary(ltmle_cde.m1_gcomp_qol)

```

The CDE estimates using g-computation estimator from the `ltmle` package for death probability and mean quality of life, setting $M=0$ are respectively :
```{r show_results_cde_m0_ltmle_gcomp, echo=TRUE}
summary.CDE.death.m0.ltmle.gcomp$effect.measures$ATE$estimate
summary.CDE.qol.m0.ltmle.gcomp$effect.measures$ATE$estimate
```

The CDE estimates using g-computation estimator from the `ltmle` package for death probability and mean quality of life, setting $M=1$ are respectively :
```{r show_results_cde_m1_ltmle_gcomp, echo=TRUE}
summary.CDE.death.m1.ltmle.gcomp$effect.measures$ATE$estimate
summary.CDE.qol.m1.ltmle.gcomp$effect.measures$ATE$estimate
```


## IPTW
### IPTW estimator of the CDE

If the controlled direct effect (CDE) is identifiable, $\Psi_{CDE_m} = \mathbb{E}(Y_{1m}) - \mathbb{E}(Y_{0m})$ can be expressed using Inverse probability of treatment weighting (IPTW), denoting $\mathbb{P}(A=a \mid L(0)) = g(A=a \mid L(0))$ and $\mathbb{P}(M=m \mid L(1), A, L(0)) = g(M=m \mid L(1), A, L(0))$:
$$\begin{equation}
\Psi_{CDE_m} = \mathbb{E}\left( \frac{\mathbb{I}(A=1,M=m)}{g(A=a \mid L(0)) \times g(M=m \mid L(1), A, L(0))} Y \right) - 
\mathbb{E}\left( \frac{\mathbb{I}(A=0,M=m)}{g(A=a \mid L(0)) \times g(M=m \mid L(1), A, L(0))} Y \right)
\end{equation}$$
  
The following steps describe the implementation of the IPTW estimator


1. Estimate the treatment mechanism $g(A=1 \mid L(0))$ and $g(M=1 \mid L(1), A, L(0))$

2. Predict each individual's probability of being exposed to her own exposure

3. Apply weights corresponding to the inverse of the predicted probability $w_i = \frac{1}{\hat{g}(A_i = a \mid L(0)_i) \times \hat{g}(M_i = m \mid L(1)_i, A_i, L(0)_i)}$

4. Use the empirical mean of the weighted outcome $Y$: $\hat{\mathbb{E}}(Y_{am}) = \frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=a, M_i=m)}{\hat{g}(A_i=a \mid L(0)_i) \times \hat{g}(M_i = m \mid L(1)_i, A_i, L(0)_i)} Y_i$

```{r Psi.CDE.iptw, echo=TRUE}
# 1. estimate treatment mechanism of A0 & M
g.A <- glm(A0_ace ~ L0_male + L0_parent_low_educ_lv, family = "binomial", data = data.sim)
g.M <- glm(M_smoking ~ L1 + A0_ace + L0_male + L0_parent_low_educ_lv, family = "binomial", data = data.sim)

# 2. predict the probability of being exposed to her own exposure
# predict the probabilities P(A0_ace=1|L(0)) & P(A0_ace=0|L(0))
pred.gA1 <- predict(g.A, type="response")
pred.gA0 <- 1 - pred.gA1
# the predicted probability of the observed treatment A_i=a is : 
gA.obs <- rep(NA, nrow(data.sim))
gA.obs[data.sim$A0_ace==1] <- pred.gA1[data.sim$A0_ace==1]
gA.obs[data.sim$A0_ace==0] <- pred.gA0[data.sim$A0_ace==0]

# predict the probabilities P(A0_ace=1|L(0)) & P(A0_ace=0|L(0))
pred.gM1 <- predict(g.M, type="response")
pred.gM0 <- 1 - pred.gM1
# the predicted probability of the observed treatment A_i=a is : 
gM.obs <- rep(NA, nrow(data.sim))
gM.obs[data.sim$M_smoking==1] <- pred.gM1[data.sim$M_smoking==1]
gM.obs[data.sim$M_smoking==0] <- pred.gM0[data.sim$M_smoking==0]

# 3. Apply weights corresponding to the inverse of the predicted probability
g <- gA.obs * gM.obs

## 4. Use the empirical mean of the weighted outcome Y

# calculate indicator functions
I.A0M0 <- data.sim$A0_ace==0 & data.sim$M_smoking==0
I.A0M1 <- data.sim$A0_ace==0 & data.sim$M_smoking==1
I.A1M0 <- data.sim$A0_ace==1 & data.sim$M_smoking==0
I.A1M1 <- data.sim$A0_ace==1 & data.sim$M_smoking==1

# point estimates
CDE.death.m0.IPTW <- mean(I.A1M0 * data.sim$Y_death / g) - mean(I.A0M0 * data.sim$Y_death / g)
CDE.death.m1.IPTW <- mean(I.A1M1 * data.sim$Y_death / g) - mean(I.A0M1 * data.sim$Y_death / g)

CDE.qol.m0.IPTW <- mean(I.A1M0 * data.sim$Y_qol / g) - mean(I.A0M0 * data.sim$Y_qol / g)
CDE.qol.m1.IPTW <- mean(I.A1M1 * data.sim$Y_qol / g) - mean(I.A0M1 * data.sim$Y_qol / g)
```

The CDE estimates using IPTW for death probability and mean quality of life, setting $M=0$ are respectively: 
```{r show_results_cde_m0_iptw, echo=TRUE}
CDE.death.m0.IPTW
CDE.qol.m0.IPTW
```

The CDE estimates using IPTW for death probability and mean quality of life, setting $M=1$ are respectively: 
```{r show_results_cde_m1_iptw, echo=TRUE}
CDE.death.m1.IPTW
CDE.qol.m1.IPTW
```


### Stabilized IPTW for the CDE
If the controlled direct effect (CDE) is identifiable, $\Psi_{CDE_m}$ can be estimated using a stabilized IPTW estimator:
$$\begin{equation}
\hat{\mathbb{E}}(Y_{1m}) - \hat{\mathbb{E}}(Y_{0m}) =  \frac{\frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=1,M_i=m)}{\hat{g}(A_i=1 \mid L(0)_i) \times \hat{g}(M_i = m \mid L(1)_i, A_i, L(0)_i)} Y_i}{ \frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=1,M_i=m)}{\hat{g}(A_i=1 \mid L(0)_i) \times \hat{g}(M_i = m \mid L(1)_i, A_i, L(0)_i)}} - \frac{\frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=0,M_i=m)}{\hat{g}(A_i=0 \mid L(0)_i) \times \hat{g}(M_i = m \mid L(1)_i, A_i, L(0)_i)} Y_i}{ \frac{1}{n} \sum_{i=1}^n \frac{\mathbb{I}(A_i=0,M_i=m)}{\hat{g}(A_i=0 \mid L(0)_i) \times \hat{g}(M_i = m \mid L(1)_i, A_i, L(0)_i)}}
\end{equation}$$
The estimation algorithm is the same as for IPTW, but applying the stabilized estimator in step 4.

```{r Psi.CDE.siptw, echo=TRUE}
# 4. Applying the stabilized estimator
# point estimates:
CDE.death.m0.sIPTW <- sum(I.A1M0 * data.sim$Y_death / g) / sum(I.A1M0 / g) - 
  sum(I.A0M0 * data.sim$Y_death / g) / sum(I.A0M0 / g)

CDE.death.m1.sIPTW <- sum(I.A1M1 * data.sim$Y_death / g) / sum(I.A1M1 / g) - 
  sum(I.A0M1 * data.sim$Y_death / g) / sum(I.A0M1 / g)

CDE.qol.m0.sIPTW <- sum(I.A1M0 * data.sim$Y_qol / g) / sum(I.A1M0 / g) - 
  sum(I.A0M0 * data.sim$Y_qol / g) / sum(I.A0M0 / g)

CDE.qol.m1.sIPTW <- sum(I.A1M1 * data.sim$Y_qol / g) / sum(I.A1M1 / g) - 
  sum(I.A0M1 * data.sim$Y_qol / g) / sum(I.A0M1 / g)
```

The CDE estimates using stabilized IPTW for death probability and mean quality of life, setting $M=0$ are respectively: 
```{r show_results_cde_m0_siptw, echo=TRUE}
CDE.death.m0.sIPTW
CDE.qol.m0.sIPTW
```

The CDE estimates using stabilized IPTW for death probability and mean quality of life, setting $M=1$ are respectively: 
```{r show_results_cde_m1_siptw, echo=TRUE}
CDE.death.m1.sIPTW
CDE.qol.m1.sIPTW
```


## Applying IPTW estimator for marginal structural models to estimate CDE
Marginal structural models (MSM) are models for the expected value of counterfactual outcomes. We can use the following MSM to estimate CDE:
$$\begin{equation*}
\mathbb{E}(Y_{am}) = \beta_0 + \beta_a A + \beta_m M + \beta_{a \ast m} (A \ast M)
\end{equation*}$$
From this MSM, controlled direct effects, setting $M=m$, are defined as:
$$\begin{equation*}
\Psi_{CDE_m} = \mathbb{E}(Y_{1m}) - \mathbb{E}(Y_{0m}) = \beta_a + \beta_{a \ast m}
\end{equation*}$$

The MSM can be estimated applying the following weighted linear regression using the observed data
$$\begin{equation*}
\hat{\mathbb{E}}(Y) = \hat{\beta}_0 + \hat{\beta}_a A + \hat{\beta}_m M + \hat{\beta}_{a \ast m} (A \ast M),
\end{equation*}$$
where stabilized weights are:
$$\begin{equation*}
sw_i = \frac{\hat{g}(A=a_i)}{\hat{g}(A=a_i \mid L(0)_i)} \times \frac{\hat{g}(M=m_i | A_i)}{\hat{g}(M=m_i \mid L(1)_i), A_i, L(0)_i)}
\end{equation*}$$

```{r Psi.CDE.iptw.msm, echo=TRUE}
# 1. estimate treatment mechanisms of A0 & M 
# for the denominator of the weights
g.A.denom <- glm(A0_ace ~ L0_male + L0_parent_low_educ_lv, family = "binomial", data = data.sim)
g.M.denom <- glm(M_smoking ~ L1 + A0_ace + L0_male + L0_parent_low_educ_lv, family = "binomial", data = data.sim)
# for the numerator of the weights
g.A.num <- glm(A0_ace ~ 1, family = "binomial", data = data.sim)
g.M.num <- glm(M_smoking ~ A0_ace, family = "binomial", data = data.sim)

# 2. predict the probability of being exposed to her own exposure
# predict the probabilities of A=1 or M=1
prob.A1.denom <- predict(g.A.denom, type="response")
prob.M1.denom <- predict(g.M.denom, type="response")
prob.A1.num <- predict(g.A.num, type="response")
prob.M1.num <- predict(g.M.num, type="response")

# the predicted probability of the observed treatment Pr(A_i=a_i | ...) and Pr(M_i = m_i | ...) are : 
prob.A.obs.denom <- prob.M.obs.denom <- rep(NA, nrow(data.sim))
prob.A.obs.denom[data.sim$A0_ace==1] <- prob.A1.denom[data.sim$A0_ace==1]
prob.A.obs.denom[data.sim$A0_ace==0] <- 1 - prob.A1.denom[data.sim$A0_ace==0]
prob.M.obs.denom[data.sim$A0_ace==1] <- prob.M1.denom[data.sim$A0_ace==1]
prob.M.obs.denom[data.sim$A0_ace==0] <- 1 - prob.M1.denom[data.sim$A0_ace==0]

prob.A.obs.num <- prob.M.obs.num <- rep(NA, nrow(data.sim))
prob.A.obs.num[data.sim$A0_ace==1] <- prob.A1.num[data.sim$A0_ace==1]
prob.A.obs.num[data.sim$A0_ace==0] <- 1 - prob.A1.num[data.sim$A0_ace==0]
prob.M.obs.num[data.sim$A0_ace==1] <- prob.M1.num[data.sim$A0_ace==1]
prob.M.obs.num[data.sim$A0_ace==0] <- 1 - prob.M1.num[data.sim$A0_ace==0]

# 3. calculate stabilized weigths for MSM
sw.msm <- (prob.A.obs.num * prob.M.obs.num) / (prob.A.obs.denom * prob.M.obs.denom)

# 4. Estimate marginal structural models
msm.death <- glm(Y_death ~ A0_ace + M_smoking + A0_ace : M_smoking, weights = sw.msm, 
                 family = "gaussian", data = data.sim) 
                 # gaussian family used to estimate a risk difference
                 # cf. Robins et al, Epidemiology 11(5);2000
msm.qol <- glm(Y_qol ~ A0_ace + M_smoking + A0_ace : M_smoking, weights = sw.msm, 
               family = "gaussian", data = data.sim)

# 5. EStimate controlled direct effects using the coefficients of the MSM
# CDE.death.m0 = E(Y_{10}) - E(Y_{00})
CDE.death.m0.MSM <- msm.death$coefficients["A0_ace"]
# CDE.death.m1 = E(Y_{11}) - E(Y_{01})
CDE.death.m1.MSM <- msm.death$coefficients["A0_ace"] + msm.death$coefficients["A0_ace:M_smoking"]
# CDE.qol.m0 = E(Y_{10}) - E(Y_{00})
CDE.qol.m0.MSM <- msm.qol$coefficients["A0_ace"]
# CDE.qol.m1 = E(Y_{11}) - E(Y_{01})
CDE.qol.m1.MSM <- msm.qol$coefficients["A0_ace"] + msm.qol$coefficients["A0_ace:M_smoking"]
```

The CDE estimates using MSM estimated by IPTW for death probability and mean quality of life, setting $M=0$ are respectively: 
```{r show_results_cde_m0_iptw_msm, echo=TRUE}
CDE.death.m0.MSM
CDE.qol.m0.MSM
```

The CDE estimates  using MSM estimated by IPTW for death probability and mean quality of life, setting $M=1$ are respectively: 
```{r show_results_cde_m1_iptw_msm, echo=TRUE}
CDE.death.m1.MSM
CDE.qol.m1.MSM
```



## TMLE and stabilized IPTW estimation of the CDE using the `ltmle` package
The `ltmle` package can be used to get TMLE and stabilized-IPTW estimation of CDE, as shown in the example below:

```{r Psi.CDE.ltmle, echo=TRUE, message=FALSE, warning=FALSE}
library(ltmle)
library(SuperLearner)
# 1) death outcome
# setting do(M=0)
ltmle_cde.m0_tmle_death <- ltmle(data = subset(data.sim, select = -Y_qol ),
                                  Anodes = c("A0_ace","M_smoking"),
                                  Cnodes = NULL,
                                  Lnodes = "L1",
                                  Ynodes = "Y_death",
                                  survivalOutcome = FALSE,
                                  abar=list(c(1,0),c(0,0)),  # setting {A0 = 1, M=0} versus {A0 = 0, M = 0}
                                  Qform = c(L1="Q.kplus1 ~ L0_male + L0_parent_low_educ_lv", 
                                                            # L1 is not affected by A0_ace
                                            Y_death="Q.kplus1 ~ L0_male + L0_parent_low_educ_lv + 
                                                                  A0_ace*M_smoking + L1"),
                                  gform = c("A0_ace ~ L0_male + L0_parent_low_educ_lv",
                                            "M_smoking ~ L0_male + L0_parent_low_educ_lv + A0_ace + L1"),
                                  SL.library=list(Q=list("SL.glm"),  # several diverse libraries should be added
                                                  g=list("SL.glm")), # several diverse libraries should be added
                                  gbounds = c(0.01,1), # by default, g-functions are truncated below 0.01 
                                  gcomp = FALSE,           # estimation by TMLE and IPTW 
                                  variance.method = "ic")
summary.CDE.death.m0.tmle <- summary(ltmle_cde.m0_tmle_death, estimator = "tmle")
summary.CDE.death.m0.iptw <- summary(ltmle_cde.m0_tmle_death, estimator = "iptw")

# setting do(M=1)
ltmle_cde.m1_tmle_death <- ltmle(data = subset(data.sim, select = -Y_qol ),
                                  Anodes = c("A0_ace","M_smoking"),
                                  Cnodes = NULL,
                                  Lnodes = "L1",
                                  Ynodes = "Y_death",
                                  survivalOutcome = FALSE,
                                  abar=list(c(1,1),c(0,1)), # setting {A0 = 1, M=1} versus {A0 = 0, M = 1}
                                  Qform = c(L1="Q.kplus1 ~ L0_male + L0_parent_low_educ_lv", 
                                                            # L1 is not affected by A0_ace
                                            Y_death="Q.kplus1 ~ L0_male + L0_parent_low_educ_lv + 
                                                                  A0_ace*M_smoking + L1"),
                                  gform = c("A0_ace ~ L0_male + L0_parent_low_educ_lv",
                                            "M_smoking ~ L0_male + L0_parent_low_educ_lv + A0_ace + L1"),
                                  SL.library=list(Q=list("SL.glm"), # several diverse libraries should be added
                                                  g=list("SL.glm")), # several diverse libraries should be added
                                  gbounds = c(0.01,1), # by default, g-functions are truncated below 0.01
                                  gcomp = FALSE,           # estimation by TMLE and IPTW 
                                  variance.method = "ic")
summary.CDE.death.m1.tmle <- summary(ltmle_cde.m1_tmle_death, estimator = "tmle")
summary.CDE.death.m1.iptw <- summary(ltmle_cde.m1_tmle_death, estimator = "iptw")

# 2) QoL outcome
# setting do(M=0)
ltmle_cde.m0_tmle_qol <- ltmle(data = subset(data.sim, select = -Y_death ),
                                  Anodes = c("A0_ace","M_smoking"),
                                  Cnodes = NULL,
                                  Lnodes = "L1",
                                  Ynodes = "Y_qol",
                                  survivalOutcome = FALSE,
                                  abar=list(c(1,0),c(0,0)),  # setting {A0 = 1, M=0} versus {A0 = 0, M = 0}
                                  Qform = c(L1="Q.kplus1 ~ L0_male + L0_parent_low_educ_lv", 
                                                # L1 is not affected by A0_ace
                                            Y_qol="Q.kplus1 ~ L0_male + L0_parent_low_educ_lv + 
                                                                A0_ace*M_smoking + L1"),
                                  gform = c("A0_ace ~ L0_male + L0_parent_low_educ_lv",
                                            "M_smoking ~ L0_male + L0_parent_low_educ_lv + A0_ace + L1"),
                                  SL.library=list(Q=list("SL.glm"), # several diverse libraries should be added
                                                  g=list("SL.glm")), # several diverse libraries should be added
                                  gbounds = c(0.01,1), # by default, g-functions are truncated below 0.01
                                  gcomp = FALSE,           # estimation by TMLE and IPTW 
                                  variance.method = "ic")
summary.CDE.qol.m0.tmle <- summary(ltmle_cde.m0_tmle_qol, estimator = "tmle")
summary.CDE.qol.m0.iptw <- summary(ltmle_cde.m0_tmle_qol, estimator = "iptw")

# setting do(M=1)
ltmle_cde.m1_tmle_qol <- ltmle(data = subset(data.sim, select = -Y_death ),
                                  Anodes = c("A0_ace","M_smoking"),
                                  Cnodes = NULL,
                                  Lnodes = "L1",
                                  Ynodes = "Y_qol",
                                  survivalOutcome = FALSE,
                                  abar=list(c(1,1),c(0,1)), # setting {A0 = 1, M=1} versus {A0 = 0, M = 1}
                                  Qform = c(L1="Q.kplus1 ~ L0_male + L0_parent_low_educ_lv", 
                                                # L1 is not affected by A0_ace
                                            Y_qol="Q.kplus1 ~ L0_male + L0_parent_low_educ_lv + 
                                                                A0_ace*M_smoking + L1"),
                                  gform = c("A0_ace ~ L0_male + L0_parent_low_educ_lv",
                                            "M_smoking ~ L0_male + L0_parent_low_educ_lv + A0_ace + L1"),
                                  SL.library=list(Q=list("SL.glm"), # several diverse libraries should be added
                                                  g=list("SL.glm")), # several diverse libraries should be added
                                  gbounds = c(0.01,1), # by default, g-functions are truncated below 0.01
                                  gcomp = FALSE,           # estimation by TMLE and IPTW  
                                  variance.method = "ic")
summary.CDE.qol.m1.tmle <- summary(ltmle_cde.m1_tmle_qol, estimator = "tmle")
summary.CDE.qol.m1.iptw <- summary(ltmle_cde.m1_tmle_qol, estimator = "iptw")
```

### Results obtained by TMLE estimation 
The CDE estimates using TMLE estimator from the `ltmle` package for death probability and mean quality of life, setting $M=0$ are respectively :
```{r show_results_cde_m0_tmle, echo=TRUE}
list("Estimate" = summary.CDE.death.m0.tmle$effect.measures$ATE$estimate,
     "CI" = summary.CDE.death.m0.tmle$effect.measures$ATE$CI)
list("Estimate" = summary.CDE.qol.m0.tmle$effect.measures$ATE$estimate,
     "CI" = summary.CDE.qol.m0.tmle$effect.measures$ATE$CI)
```

The CDE estimates using TMLE estimator from the `ltmle` package for death probability and mean quality of life, setting $M=1$ are respectively :
```{r show_results_cde_m1_tmle, echo=TRUE}
list("Estimate" = summary.CDE.death.m1.tmle$effect.measures$ATE$estimate,
     "CI" = summary.CDE.death.m1.tmle$effect.measures$ATE$CI)
list("Estimate" = summary.CDE.qol.m1.tmle$effect.measures$ATE$estimate,
     "CI" = summary.CDE.qol.m1.tmle$effect.measures$ATE$CI)
```

### Results obtained by stabilized IPTW estimation 
The CDE estimates using IPTW estimator from the `ltmle` package for death probability and mean quality of life, setting $M=0$ are respectively :
```{r show_results_cde_m0_iptw_ltmle, echo=TRUE}
list("Estimate" = summary.CDE.death.m0.iptw$effect.measures$ATE$estimate,
     "CI" = summary.CDE.death.m0.iptw$effect.measures$ATE$CI)
list("Estimate" = summary.CDE.qol.m0.iptw$effect.measures$ATE$estimate,
     "CI" = summary.CDE.qol.m0.iptw$effect.measures$ATE$CI)
```

The CDE estimates using IPTW estimator from the `ltmle` package for death probability and mean quality of life, setting $M=1$ are respectively :
```{r show_results_cde_m1_iptw_ltmle, echo=TRUE}
list("Estimate" = summary.CDE.death.m1.iptw$effect.measures$ATE$estimate,
     "CI" = summary.CDE.death.m1.iptw$effect.measures$ATE$CI)
list("Estimate" = summary.CDE.qol.m1.iptw$effect.measures$ATE$estimate,
     "CI" = summary.CDE.qol.m1.iptw$effect.measures$ATE$CI)
```

# Natural direct and indirect effects
## Reminders on the definitions of (PNDE and TNIE) or (TNDE and PNIE)
## G-computation

## Using IPTW and Marginal structural models

## Using regressions





